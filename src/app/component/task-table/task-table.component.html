<div
  class="d-flex align-items-center justify-content-center mt-5 mb-5"
  *ngIf="isLoading"
>
  <mat-spinner mode="indeterminate"></mat-spinner>
</div>

<div
  *ngIf="errorStates.tasks && !isLoading"
  class="alert alert-danger text-center"
>
  {{ errorStates.tasks }}
</div>

<div *ngIf="!errorStates.tasks && !isLoading">
  <div class="table-container">
    <div class="table-wrapper">
      <table
        mat-table
        [dataSource]="dataSource"
        matSort
        (matSortChange)="sortData($event)"
        style="background-color: transparent"
      >
        <!-- Name Column -->
        <ng-container matColumnDef="name">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Name</th>
          <td mat-cell *matCellDef="let task">
            <span class="task-name" [title]="task.name">{{ task.name }}</span>
          </td>
        </ng-container>

        <!-- Start Date Column -->
        <ng-container matColumnDef="startDate">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Start Date</th>
          <td mat-cell *matCellDef="let task">{{ task.startDate }}</td>
        </ng-container>

        <!-- Due Date Column -->
        <ng-container matColumnDef="dueDate">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Due Date</th>
          <td mat-cell *matCellDef="let task">{{ task.dueDate }}</td>
        </ng-container>

        <!-- Completion Date Column -->
        <ng-container matColumnDef="completionDate">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>
            Completion Date
          </th>
          <td mat-cell *matCellDef="let task">{{ task.completionDate }}</td>
        </ng-container>

        <!-- Priority Column -->
        <ng-container matColumnDef="priority">
          <th mat-header-cell *matHeaderCellDef>
            <div class="d-flex align-items-center">
              <div style="width: 90px">
                <mat-select
                  placeholder="Priority"
                  [(value)]="selectedPriority"
                  (selectionChange)="selectPriority($event.value)"
                >
                  <mat-option
                    *ngFor="let priority of availablePriorities"
                    [value]="priority"
                  >
                    {{ priorityLabels[priority] }}
                  </mat-option>
                </mat-select>
              </div>
              <button
                mat-button
                *ngIf="selectedPriority"
                (click)="resetPriority()"
              >
                <mat-icon>close</mat-icon>
              </button>
            </div>
          </th>
          <td
            style="text-align: center"
            mat-cell
            *matCellDef="let task"
            [ngClass]="getPriorityClass(task.priority)"
          >
            {{ task.priority }}
          </td>
        </ng-container>

        <!-- Status Colum -->
        <ng-container matColumnDef="status">
          <th mat-header-cell *matHeaderCellDef>
            <div class="d-flex align-items-center">
              <div style="width: 120px">
                <mat-select
                  placeholder="Status"
                  [(value)]="selectedStatus"
                  (selectionChange)="selectStatus($event.value)"
                >
                  <mat-option
                    *ngFor="let status of availableStatuses"
                    [value]="status"
                  >
                    {{ statusLabels[status] }}
                  </mat-option>
                </mat-select>
              </div>
              <button mat-button *ngIf="selectedStatus" (click)="resetStatus()">
                <mat-icon>close</mat-icon>
              </button>
            </div>
          </th>
          <td mat-cell *matCellDef="let task" style="text-align: center">
            <mat-icon
              style="cursor: pointer; overflow: visible"
              [ngbTooltip]="getTooltipText(task.status)"
              [ngClass]="getStatusClass(task.status)"
            >
              circle
            </mat-icon>
          </td>
        </ng-container>

        <!-- Owner Column with Filter -->
        <ng-container matColumnDef="owner">
          <th mat-header-cell *matHeaderCellDef>Owner</th>
          <td mat-cell *matCellDef="let task">{{ task.ownerUsername }}</td>
        </ng-container>

        <!-- Description Column -->
        <ng-container matColumnDef="description">
          <th mat-header-cell *matHeaderCellDef>Description</th>
          <td mat-cell *matCellDef="let task">
            <span class="task-description" [title]="task.description">{{
              task.description
            }}</span>
          </td>
        </ng-container>

        <!-- Actions Column -->
        <ng-container matColumnDef="actions">
          <th mat-header-cell *matHeaderCellDef>Actions</th>
          <td mat-cell *matCellDef="let task">
            <span [ngbTooltip]="getCompleteTooltip(task)">
              <button
                mat-icon-button
                class="btn complete-button"
                [disabled]="
                  task.status === 'COMPLETED' || isLoading || isBeforeStart(task)
                "
                (click)="openCompleteDialog(task)"
              >
                <mat-icon>check</mat-icon>
              </button>
            </span>
            <button
              mat-icon-button
              class="btn btn-outline-primary"
              [disabled]="task.status === 'COMPLETED' || isLoading"
              (click)="openEditDialog(task)"
            >
              <mat-icon>edit</mat-icon>
            </button>
            <button
              mat-icon-button
              class="btn btn-outline-danger"
              [disabled]="task.status === 'COMPLETED' || isLoading"
              (click)="openDeleteDialog(task)"
            >
              <mat-icon>delete</mat-icon>
            </button>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr
          mat-row
          *matRowDef="let row; columns: displayedColumns"
          class="tableRow"
        ></tr>
      </table>
    </div>
  </div>

  <mat-paginator
    [length]="totalElements"
    [hidePageSize]="true"
    [pageSize]="pageSize"
    [pageIndex]="currentPage"
    (page)="onPageChange($event)"
    style="background-color: transparent"
  ></mat-paginator>
</div>
